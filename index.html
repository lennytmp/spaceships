<html>
<head>
  <title>Spaceships Prototype</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" ></script>
  <link rel="stylesheet" href="http://getbootstrap.com/2.0.4/assets/css/bootstrap-responsive.css">
  <script>
  GARAGE_MODE = 0;
  FIGHT_MODE = 1;
  HP_UNIT = 10;
  var mode = GARAGE_MODE;

  function doUpgrade(myShip, room) {
    if (!room.upgrade || !room.upgrade.cost || !myShip.haveEnoughResources(room.upgrade.cost)) {
      return false;
    }
    var cost = room.upgrade.cost;
    myShip.chargeCost(cost);
    for (key in room.upgrade.improvements) {
      room[key] += room.upgrade.improvements[key];
    }
    for (var resType in cost) {
      cost[resType] *= 2;
    }
    return true;
  }

  Ship.prototype.chargeCost = function(cost) {
      for (var resType in cost) {
        this.resources[resType] -= cost[resType];
      }
  }

  function renderEasy(obj, includeOnly, exclude) {
    out = "";
    for (var i in obj) {
      if (obj.hasOwnProperty(i)) {
        if (includeOnly !== undefined && !includeOnly.has(i)) {
          continue;
        }
        if (exclude !== undefined && exclude.has(i)) {
          continue;
        }
        if (!(obj[i] instanceof Object)) {
          out += "<li>" + i + ": " + obj[i] + "</li>";
        } else if (obj[i].render) {
          out += "<li>" + i + ": " + obj[i].render() + "</li>";
        }
      }
    }
    return out;
  }

  function Ship() {
    this.rooms = [];
    this.maxRooms = 3;
    this.resources = {"minerals": 100, "gas": 100};
    this.maxRoomId = 0;
    this.isMine = false;
  }

  function Upgrade(minerals, gas, improvements) {
    this.cost = {"minerals": minerals, "gas": gas};
    this.improvements = improvements;
  }
  Upgrade.prototype.render = function() {
    out = "<ul>";
    out += renderEasy(this);
    out += "<li>Cost: <ul>" + renderEasy(this.cost) + "</ul></li>";
    out += "<li>Improvements (delta): <ul>" + renderEasy(this.improvements) + "</ul></li>";
    out += "</ul>";
    return out;
  }

  function LaserRoom(id) {
    this.id = id;
    this.title = "Laser";
    this.hp = 10*HP_UNIT;
    this.maxHp = this.hp;
    this.damage = HP_UNIT;
    this.targetId = 0;
    this.lastShotAt = 0;
    this.fireRate = 10;
    this.upgrade = new Upgrade(100, 0, {damage: 1});
  }
  LaserRoom.prototype.render = function(ship, enemy) {
    out = "<ul>";
    if (mode == FIGHT_MODE) {
        out += renderEasy(this, undefined, new Set(["upgrade"]));
      if (ship.isMine) {
        out += `<li>Target: <select class="target" id="${this.id}_target">`;
        for (k in enemy.rooms) {
          var target = enemy.rooms[k];
          if (target.hp <= 0) {
            continue;
          }
          var selected = "";
          if (this.targetId == target.id) {
            selected = "selected";
          }
          out += `<option ${selected} value="${target.id}">${target.title}-${target.id}</option>`;
        }
        out += "</select></li>";
      }
    } else {
      if (ship.isMine && mode == GARAGE_MODE) {
        out += renderEasy(this);
        if (mode == GARAGE_MODE && this.upgrade && this.upgrade.cost && ship.haveEnoughResources(this.upgrade.cost)) {
          out += "<li><a href='#' class='upgrade' id='upgrade_" + this.id + "'>Upgrade</a></li>";
        }
      }
    }
    out += "</ul>";
    return out;
  }

  function ReactorRoom(id) {
    this.id = id;
    this.hp = 10*HP_UNIT;
    this.maxHp = this.hp;
    this.title = "Reactor";
    this.energyMax = 3;
    this.upgrade = new Upgrade(100, 100, {energyMax: 1});
  }

  ReactorRoom.prototype.render = function(ship) {
    out = "<ul>";
    if (ship.isMine) {
      out += renderEasy(this);
    } else {
      out += renderEasy(this, undefined, new Set(["upgrade"]));
    }
    if (ship.isMine && mode == GARAGE_MODE) {
      if (mode == GARAGE_MODE && this.upgrade && this.upgrade.cost && ship.haveEnoughResources(this.upgrade.cost)) {
        out += "<li><a href='#' class='upgrade' id='upgrade_" + this.id + "'>Upgrade</a></li>";
      }
    }
    out += "</ul>";
    return out;
  }

  function BedRoom(id) {
    this.id = id;
    this.hp = HP_UNIT;
    this.maxHp = this.hp;
    this.title = "Bedroom";
    this.capacity = 1;
  }
  BedRoom.prototype.render = function() {
    out = "<ul>";
    out += renderEasy(this);
    out += "</ul>";
    return out;
  }

  Ship.prototype.addRoom = function(room) {
    this.rooms[this.maxRoomId] = room;
    this.maxRoomId++;
  }
  function renderMyShip(ship, enemy) {
    out = "<ul>";
    out += renderEasy(ship);
    out += `<li>Resources: <ul>${renderEasy(ship.resources)}</ul></li>`;
    out += "</ul>";
    out += "Rooms:<br /> <ul>";
    for (id in ship.rooms) {
      var room = ship.rooms[id];
      out += `
        <li>${room.title}<ul>
          ${room.render(ship, enemy)}
        </li></ul>`;
    }
    out += "</ul>";
    return out;
  }

  function renderEnemyShip(ship) {
    out = "<ul>";
    out += renderEasy(ship);
    out += `<li>Resources: <ul>${renderEasy(ship.resources)}</ul></li>`;
    out += "</ul>";
    out += "Rooms:<br /> <ul>";
    for (id in ship.rooms) {
      var room = ship.rooms[id];
      out += `
      <li>${room.title}<ul>
        ${room.render(ship)}
      </li></ul>`;
    }
    out += "</ul>";
    return out;
  }

  Ship.prototype.haveEnoughResources = function(cost) {
      for (var resType in cost) {
        if (this.resources[resType] < cost[resType]) {
          return false;
        }
      }
      return true;
  }


  var myShip = new Ship();
  myShip.isMine = true;
  myShip.addRoom(new LaserRoom(myShip.maxRoomId));
  myShip.addRoom(new ReactorRoom(myShip.maxRoomId));
  myShip.addRoom(new BedRoom(myShip.maxRoomId));

 // onload aka main
  $(function() {
    $("#you").html(renderMyShip(myShip));

    $("#you").on('click', 'a.upgrade', function(){
      id = parseInt($(this).attr("id").split("_")[1]);
      if (!doUpgrade(myShip, myShip.rooms[id])) {
        alert("Could not do the upgrade!");
      } else {
        alert("Success");
        $("#you").html(renderMyShip(myShip));
      }
    });

    $("#you").on('change', 'select.target', function(){
      id = parseInt($(this).attr("id").split("_")[0]);
      myShip.rooms[id].targetId = $(this).val();
      $("#you").html(renderMyShip(myShip));
    });

    
    setInterval(function() {
        recoverHp(myShip);
      }, 1000);
  });

  function recoverHp(myShip) {
    if (mode != GARAGE_MODE) {
      return;
    }
    var recovered = false;
    for (var k in myShip.rooms) {
      var room = myShip.rooms[k];
      if (room.hp < room.maxHp) {
        recovered = true;
        room.hp += HP_UNIT;
        if (room.hp > room.maxHp) {
          room.hp = room.maxHp;
        }
        break;
      }
    }
    if (recovered) {
      $("#you").html(renderMyShip(myShip));
    }
  }

  function fight() {
    $("#enemy-title").show();
    mode = FIGHT_MODE;
    var enemy = new Ship();
    enemy.addRoom(new LaserRoom(enemy.maxRoomId));
    enemy.addRoom(new ReactorRoom(enemy.maxRoomId));
    enemy.addRoom(new BedRoom(enemy.maxRoomId));
    $("#enemy").html(renderEnemyShip(enemy));

    $("#fight-button").hide();
    $("#you").html(renderMyShip(myShip, enemy));
    setTimeout(function() {
        progressFight(myShip, enemy);
      }, 1000);
  }

  function getShipTargetsDamage(ship) {
    var myDamage = {};
    for (var k in ship.rooms) {
      var room = ship.rooms[k];
      if (room.title == "Laser") {
        if (myDamage[room.targetId] === undefined) {
          myDamage[room.targetId] = 0;
        }
        myDamage[room.targetId] += room.damage;
      }
    }
    return myDamage;
  }

  function checkDead(ship) {
    for (var k in ship.rooms) {
      if (ship.rooms[k].hp > 0) {
        return false;
      }
    }
    return true;
  }

  function setNewTargetsIfNeeded(ship, enemy) {
    var newTarget;
    for (var k in enemy.rooms) {
      if (enemy.rooms[k].hp > 0) {
        newTarget = enemy.rooms[k].id;
      }
    }
    for (var k in ship.rooms) {
      var room = ship.rooms[k];
      if (room.title == "Laser") {
        if (enemy.rooms[room.targetId].hp <= 0) {
          room.targetId = newTarget;
        }
      }
    }
  }

  function applyDamage(ship, damage) {
    var myDamage = {};
    for (var id in damage) {
      var target = ship.rooms[id];
      target.hp -= damage[id];
      if (target.hp < 0) {
        target.hp = 0;
      }
    }
  }

  function finishFight() {
      mode = GARAGE_MODE;
      $("#enemy-title").hide();
      $("#fight-button").show();
      $("#enemy").html("");
      $("#you").html(renderMyShip(myShip));
  }

  function progressFight(myShip, enemy) {
    // TODO: This is biased towards the damage from my ship, it shouldn't be.
    enemyDamage = getShipTargetsDamage(myShip);
    myDamage = getShipTargetsDamage(enemy);
    applyDamage(enemy, enemyDamage);
    applyDamage(myShip, myDamage);
    if (checkDead(enemy)) {
      alert("You won!");
      for (type in enemy.resources) {
        myShip.resources[type] += enemy.resources[type];
      }
      finishFight();
      return;
    }
    if (checkDead(myShip)) {
      alert("You lost!");
      finishFight();
      return;
    }
    setNewTargetsIfNeeded(myShip, enemy);
    setNewTargetsIfNeeded(enemy, myShip);

    $("#enemy").html(renderEnemyShip(enemy));
    $("#you").html(renderMyShip(myShip, enemy));

    console.log("Tick");
    setTimeout(function() {
        progressFight(myShip, enemy);
      }, 1000);
  }
  </script>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="span4">
        <a id="fight-button" href="#" onclick="fight()">Fight</a>
      </div>
    </div>
    <div class="row">
    <div class="span4">
      <h2>Your ship</h2>
      <div id="you"></div>
    </div>
    <div class="span4">
      <h2 id="enemy-title" style="display:none;">Enemy</h2>
      <div id="enemy"></div>
    </div>
    </div>
  </div>
</body>
</html>
