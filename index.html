<html ng-app="gameApp">
<head>
  <title>Spaceships Prototype</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" ></script>
  <link rel="stylesheet" href="http://getbootstrap.com/2.0.4/assets/css/bootstrap-responsive.css">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
  <style>
    .progressFrame {
      height: 20px;
      width: 100px;
      border: 1px solid;
    }
    .progressFill {
      height: 20px;
      white-space: nowrap;
      text-align: center;
    }
  </style>
  <script>
  var GARAGE_MODE = 0;
  var FIGHT_MODE = 1;
  var HP_UNIT = 10;
  var MAX_FIGHT_TICKS = 90;

  var mode = GARAGE_MODE;

  function doUpgrade(myShip, room) {
    if (!room.upgrade || !room.upgrade.cost || !myShip.haveEnoughResources(room.upgrade.cost)) {
      return false;
    }
    var cost = room.upgrade.cost;
    myShip.chargeCost(cost);
    for (key in room.upgrade.improvements) {
      room[key] += room.upgrade.improvements[key];
    }
    for (var resType in cost) {
      cost[resType] *= 2;
    }
    return true;
  }

  Ship.prototype.chargeCost = function(cost) {
      for (var resType in cost) {
        this.resources[resType] -= cost[resType];
      }
  }

  function Ship() {
    this.rooms = [];
    this.maxRooms = 3;
    this.resources = {"minerals": 100, "gas": 100};
    this.maxRoomId = 0;
    this.isMine = false;
  }

  function Upgrade(minerals, gas, improvements) {
    this.cost = {"minerals": minerals, "gas": gas};
    this.improvements = improvements;
  }

  function LaserRoom(id) {
    this.id = id;
    this.title = "Laser";
    this.hp = 10*HP_UNIT;
    this.maxHp = this.hp;
    this.damage = HP_UNIT;
    this.targetId = 0;
    this.lastShotAt = 0;
    this.fireRate = 10;
    this.upgrade = new Upgrade(100, 0, {damage: 1});
  }
  function ReactorRoom(id) {
    this.id = id;
    this.hp = 10*HP_UNIT;
    this.maxHp = this.hp;
    this.title = "Reactor";
    this.energyMax = 3;
    this.upgrade = new Upgrade(100, 100, {energyMax: 1});
  }

  function BedRoom(id) {
    this.id = id;
    this.hp = HP_UNIT;
    this.maxHp = this.hp;
    this.title = "Bedroom";
    this.capacity = 1;
  }

  Ship.prototype.addRoom = function(room) {
    this.rooms[this.maxRoomId] = room;
    this.maxRoomId++;
  }

  Ship.prototype.haveEnoughResources = function(cost) {
      for (var resType in cost) {
        if (this.resources[resType] < cost[resType]) {
          return false;
        }
      }
      return true;
  }

  function recoverHp(myShip, mode) {
    if (mode != GARAGE_MODE) {
      return;
    }
    var recovered = false;
    for (var k in myShip.rooms) {
      var room = myShip.rooms[k];
      if (room.hp < room.maxHp) {
        room.hp += HP_UNIT;
        if (room.hp > room.maxHp) {
          room.hp = room.maxHp;
        }
        break;
      }
    }
  }


  function getShipTargetsDamage(ship) {
    var myDamage = {};
    for (var k in ship.rooms) {
      var room = ship.rooms[k];
      if (room.title == "Laser") {
        if (myDamage[room.targetId] === undefined) {
          myDamage[room.targetId] = 0;
        }
        myDamage[room.targetId] += (room.hp/room.maxHp)*room.damage;
      }
    }
    return myDamage;
  }

  function checkDead(ship) {
    for (var k in ship.rooms) {
      if (ship.rooms[k].hp > 0) {
        return false;
      }
    }
    return true;
  }

  function setNewTargetsIfNeeded(ship, enemy) {
    var newTarget;
    for (var k in enemy.rooms) {
      if (enemy.rooms[k].hp > 0) {
        newTarget = enemy.rooms[k].id;
        break;
      }
    }
    for (var k in ship.rooms) {
      var room = ship.rooms[k];
      if (room.title == "Laser") {
        if (enemy.rooms[room.targetId].hp <= 0) {
          room.targetId = newTarget;
        }
      }
    }
  }

  function applyDamage(ship, damage) {
    var myDamage = {};
    for (var id in damage) {
      var target = ship.rooms[id];
      target.hp -= Math.round(damage[id]);
      if (target.hp < 0) {
        target.hp = 0;
      }
    }
  }


  function progressFight(myShip, enemy, timeElapsed, callback) {
    if (timeElapsed >= MAX_FIGHT_TICKS) {
      alert("Draw due to timeout!");
      callback();
      return;
    }
    // TODO: This is biased towards the damage from my ship, it shouldn't be.
    enemyDamage = getShipTargetsDamage(myShip);
    myDamage = getShipTargetsDamage(enemy);
    applyDamage(enemy, enemyDamage);
    applyDamage(myShip, myDamage);
    if (checkDead(enemy)) {
      alert("You won!");
      for (type in enemy.resources) {
        myShip.resources[type] += enemy.resources[type];
      }
      callback();
      return;
    }
    if (checkDead(myShip)) {
      alert("You lost!");
      callback();
      return;
    }
    setNewTargetsIfNeeded(myShip, enemy);
    setNewTargetsIfNeeded(enemy, myShip);

    console.log("Tick");
    setTimeout(function() {
        progressFight(myShip, enemy, timeElapsed + 1, callback);
      }, 1000);
  }
  </script>
  <script>
  var app = angular.module("gameApp", []);
  app.controller("appController",
    function($scope, $timeout) {
      $scope.GARAGE_MODE = GARAGE_MODE;
      $scope.FIGHT_MODE = FIGHT_MODE;

      var myShip = new Ship();
      myShip.isMine = true;
      myShip.addRoom(new LaserRoom(myShip.maxRoomId));
      myShip.addRoom(new ReactorRoom(myShip.maxRoomId));
      myShip.addRoom(new BedRoom(myShip.maxRoomId));

      $scope.myShip = myShip;
      $scope.mode = GARAGE_MODE;

      // onload aka main
      $scope.upgrade = function(id) {
        if (!doUpgrade(myShip, myShip.rooms[id])) {
          alert("Could not do the upgrade!");
        } else {
          alert("Success");
        }
      };

      $scope.fight = function() {
        var enemy = new Ship();
        enemy.addRoom(new LaserRoom(enemy.maxRoomId));
        enemy.addRoom(new ReactorRoom(enemy.maxRoomId));
        enemy.addRoom(new BedRoom(enemy.maxRoomId));
        $scope.enemy = enemy;
        $scope.mode = $scope.FIGHT_MODE;

        setTimeout(function() {
            progressFight(myShip, enemy, 0, function() {
              $scope.mode = $scope.GARAGE_MODE;
            });
            $scope.$apply();
          }, 1000);
      };


        
      setInterval(function() {
          recoverHp(myShip, $scope.mode);
          $scope.$apply();
        }, 1000);
    });
  </script>
</head>
<body ng-controller="appController">
  <div class="container">
    <div class="row">
      <div class="span4">
        <a ng-if="mode==GARAGE_MODE" id="fight-button" ng-click="fight()" href="#">Fight</a>
        <span ng-if="mode==FIGHT_MODE">1:30</span>
      </div>
    </div>
    <div class="row">
    <div class="span4">
      <h2>Your ship</h2>
      <div id="you">
        <ul>
          <li>Ship size: {{ $myShip.maxRooms }}</li>
          <li>Resources: {{ myShip.resources}}</li>
          <li>Rooms:
            <ul ng-repeat="room in myShip.rooms">
              <li ng-switch on="room.title">{{room.title}}-{{room.id}}
                <ul>
                  <li>
                    <div class="progressFrame" style="border-color:red;">
                      <div class="progressFill" style="width:{{room.hp*100/room.maxHp}}%;background-color:red;">
                        Hp: {{room.hp}}/{{room.maxHp}}
                      </div>
                    </div>
                  </li>
                  <li ng-switch-when="Laser">Damage: {{room.damage}}</li>
                  <li ng-switch-when="Laser">Fire rate: {{room.fireRate}}</li>
                  <li ng-if="mode==FIGHT_MODE" ng-switch-when="Laser">
                    <select ng-model="room.targetId" class="target" ng-init="room.targetId='0'">
                      <option ng-repeat="enemyRoom in enemy.rooms" value="{{enemyRoom.id}}" ng-selected="room.targetId==enemyRoom.id">{{enemyRoom.title}}-{{enemyRoom.id}}</options>
                    </select>
                  </li>
                  <li ng-switch-when="Reactor">Max energy output: {{room.energyMax}}</li>
                  <li ng-if="mode==GARAGE_MODE && room.upgrade">
                    <a ng-if="myShip.haveEnoughResources(room.upgrade.cost)" href="#" id="updrade_{{room.id}}" ng-click="upgrade(room.id)">Upgrade</a>
                    <span ng-if="!myShip.haveEnoughResources(room.upgrade.cost)">Upgrade</span>:
                    {{room.upgrade}}</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    <div class="span4">
      <h2 ng-if="mode==FIGHT_MODE">Enemy</h2>
      <div ng-if="mode==FIGHT_MODE" id="enemy">
        <ul>
          <li>Resources: {{ enemy.resources}}</li>
          <li>Rooms:
            <ul ng-repeat="room in enemy.rooms">
              <li ng-switch on="room.title">{{room.title}}-{{room.id}}
                <ul>
                  <li>
                    <div class="progressFrame" style="border-color:red;">
                      <div class="progressFill" style="width:{{room.hp*100/room.maxHp}}%;background-color:red;">
                        Hp: {{room.hp}}/{{room.maxHp}}
                      </div>
                    </div>
                  </li>
                  <li ng-switch-when="Laser">Damage: {{room.damage}}</li>
                  <li ng-switch-when="Laser">Fire rate: {{room.fireRate}}</li>
                  <li ng-if="mode==FIGHT_MODE" ng-switch-when="Laser">Targeting: {{myShip.rooms[room.targetId].title}}-{{room.targetId}}</li>
                  <li ng-switch-when="Reactor">Max energy output: {{room.energyMax}}</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    </div>
  </div>
</body>
</html>
